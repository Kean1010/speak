<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview Bot with Video & Voice v2.0</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            gap: 10px;
            position: relative;
        }
        .video-container {
            width: 100%;
            max-width: 350px;
            margin: 0 auto;
            position: relative;
        }
        .video-container video {
            width: 100%;
            height: auto;
        }
        #subtitles {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            text-align: center;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.5s ease;
            word-wrap: break-word;
        }
        .chat-container {
            flex: 1;
            border: 1px solid #ccc;
            padding: 10px;
            height: 30vh;
            overflow-y: auto;
            box-sizing: border-box;
            display: none; /* Hidden until end */
        }
        .chat-content {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .message {
            margin: 0;
            padding: 5px;
            border-radius: 3px;
            word-wrap: break-word;
        }
        .bot-message {
            background-color: #f0f0f0;
        }
        .user-message {
            background-color: #e0f0ff;
            margin-left: 10%;
        }
        .filler {
            color: red;
            font-weight: bold;
        }
        .relevant {
            background-color: yellow;
            font-weight: bold;
        }
        .input-container {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
        }
        .input-container button {
            padding: 8px 12px;
            font-size: 14px;
        }
        #progressBar {
            width: 100%;
            max-width: 400px;
            margin: 10px auto;
        }
        #progressBar progress {
            width: 100%;
        }
        #scoreDisplay {
            text-align: center;
            font-size: 16px;
            margin: 10px 0;
        }
        @media (min-width: 600px) {
            .container {
                flex-direction: row;
            }
            .video-container {
                width: 50%;
            }
            .chat-container {
                width: 50%;
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="video-container">
            <video id="video" autoplay playsinline></video>
            <div id="subtitles"></div>
            <canvas id="canvas" style="display:none"></canvas>
        </div>
        <div class="chat-container" id="chatContainer">
            <div class="chat-content" id="chatContent"></div>
        </div>
    </div>
    <div id="progressBar"><progress id="progress" value="0" max="100"></progress></div>
    <div id="scoreDisplay">Score: 0/100</div>
    <div class="input-container">
        <button id="startInterview">Start Interview</button>
        <button id="doneButton" disabled>Okay, I'm done</button>
    </div>

    <script>
        // Interview setup
        const interviewQuestions = [
            "Tell me about yourself.",
            "What are your strengths?",
            "What are your weaknesses?",
            "Why do you want this job?",
            "Where do you see yourself in 5 years?"
        ];

        let currentQuestionIndex = 0;
        let score = 0;
        let feedbackDetails = [];
        let responseStartTime;
        let fullTranscript = "";
        let allTranscripts = [];
        const maxResponseTime = 60000;

        // Video setup
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const subtitles = document.getElementById("subtitles");

        // Speech setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;

        // Common filler words and keywords
        const fillerWords = ["um", "uh", "like", "you know", "basically", "er", "ah", "so", "well", "actually"];
        const keywordMap = {
            "Tell me about yourself.": ["experience", "background", "skills"],
            "What are your strengths?": ["strong", "good at", "skill"],
            "What are your weaknesses?": ["weak", "improve", "challenge"],
            "Why do you want this job?": ["interested", "role", "company"],
            "Where do you see yourself in 5 years?": ["future", "goal", "plan"]
        };

        // Button references
        const startButton = document.getElementById("startInterview");
        const doneButton = document.getElementById("doneButton");

        // Initialize
        function startInterview() {
            addMessage("Welcome! Please allow camera and microphone access.", "bot");
            setupVideo();
            setupSpeech();
            recognition.start();
            updateProgress();
            askQuestion();
            startButton.disabled = true;
            doneButton.disabled = false;
        }

        // Video/Posture/Facial Expression Detection
        async function setupVideo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.addEventListener('loadedmetadata', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    analyzeVideo();
                });
            } catch (err) {
                addMessage("Error accessing camera: " + err.message, "bot");
            }
        }

        function analyzeVideo() {
            setInterval(() => {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                const brightness = data.reduce((sum, val) => sum + val) / (canvas.width * canvas.height * 4);
                if (brightness < 50) {
                    feedbackDetails.push("Posture: Could you sit up straighter?");
                    score -= 2;
                }

                let smileScore = 0;
                const mouthYStart = Math.floor(canvas.height * 0.75);
                const mouthYEnd = Math.floor(canvas.height * 0.9);
                const mouthXStart = Math.floor(canvas.width * 0.3);
                const mouthXEnd = Math.floor(canvas.width * 0.7);
                for (let y = mouthYStart; y < mouthYEnd; y += 2) {
                    for (let x = mouthXStart; x < mouthXEnd; x += 2) {
                        const i = (y * canvas.width + x) * 4;
                        const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        if (brightness > 150) smileScore++;
                    }
                }
                if (smileScore > 500) feedbackDetails.push("Expression: Nice smile!");
                else if (smileScore < 200) feedbackDetails.push("Expression: Try smiling more.");

                updateScore();
            }, 5000);
        }

        // Speech Analysis
        function setupSpeech() {
            let timeout;
            recognition.onresult = (event) => {
                let interimTranscript = '';
                fullTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        fullTranscript += transcript + " ";
                    } else {
                        interimTranscript += transcript;
                    }
                }

                const displayText = fullTranscript + interimTranscript;
                subtitles.textContent = displayText;
                subtitles.style.opacity = 1;

                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    subtitles.style.opacity = 0;
                }, 1000); // Fade out 1s after last speech
            };

            recognition.onend = () => {
                console.log("Speech recognition ended, restarting...");
                recognition.start();
            };

            recognition.onerror = (event) => {
                addMessage("Speech recognition error: " + event.error, "bot");
                if (event.error !== "aborted") {
                    setTimeout(() => recognition.start(), 1000);
                }
            };
        }

        function countFillers(text) {
            const words = text.toLowerCase().split(/\s+/).filter(word => word.length > 0);
            const fillerCounts = {};
            fillerWords.forEach(filler => {
                const regex = new RegExp(`\\b${filler}\\b`, "gi");
                const count = (text.match(regex) || []).length;
                if (count > 0) fillerCounts[filler] = count;
            });
            return fillerCounts;
        }

        // Chat functions
        function addMessage(text, type, highlight = false) {
            const container = document.getElementById("chatContent");
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message", type === "bot" ? "bot-message" : "user-message");

            if (highlight && type === "user") {
                let highlightedText = text;
                fillerWords.forEach(filler => {
                    const regex = new RegExp(`\\b${filler}\\b`, "gi");
                    highlightedText = highlightedText.replace(regex, `<span class="filler">${filler}</span>`);
                });
                const keywords = keywordMap[interviewQuestions[currentQuestionIndex - 1]] || [];
                keywords.forEach(word => {
                    const regex = new RegExp(`\\b${word}\\b`, "gi");
                    highlightedText = highlightedText.replace(regex, `<span class="relevant">${word}</span>`);
                });
                messageDiv.innerHTML = highlightedText;
            } else {
                messageDiv.textContent = text;
            }

            container.appendChild(messageDiv);
            const chatContainer = document.getElementById("chatContainer");
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function askQuestion() {
            if (currentQuestionIndex < interviewQuestions.length) {
                addMessage(interviewQuestions[currentQuestionIndex], "bot");
                responseStartTime = Date.now();
                updateProgress();
            } else {
                endInterview();
            }
        }

        // Evaluation
        function evaluateResponse(text, responseTime) {
            let questionScore = 100;
            let feedback = [];
            const fillerCounts = countFillers(text);
            const totalFillers = Object.values(fillerCounts).reduce((sum, count) => sum + count, 0);
            const wordCount = text.split(/\s+/).length;
            const uniqueWords = new Set(text.toLowerCase().split(/\s+/)).size;

            if (totalFillers > 1) {
                const fillerPenalty = Math.min(50, (totalFillers - 1) * 10);
                questionScore -= fillerPenalty;
                const fillerDetails = Object.entries(fillerCounts)
                    .map(([word, count]) => `${word} (${count})`)
                    .join(", ");
                feedback.push(`Filler words detected: ${fillerDetails}`);
            }

            const lengthScore = Math.min(20, Math.max(0, (50 - text.length) / 2));
            questionScore -= lengthScore;
            if (lengthScore > 0) feedback.push(`Response too short (${text.length} chars)`);

            const timePenalty = responseTime < 10000 ? 10 * (10 - responseTime / 1000) :
                              responseTime > 45000 ? 10 * (responseTime / 1000 - 45) : 0;
            questionScore -= Math.min(20, timePenalty);
            if (timePenalty > 0) {
                feedback.push(responseTime < 10000 ? "Too rushed" : "Too long");
            }

            const vocabScore = Math.min(20, Math.max(0, (wordCount * 0.5 - uniqueWords) * 2));
            questionScore -= vocabScore;
            if (vocabScore > 0) feedback.push("Limited vocabulary variety");

            const question = interviewQuestions[currentQuestionIndex];
            const keywords = keywordMap[question] || ["answer", "response"];
            const relevanceScore = keywords.reduce((count, word) => 
                count + (text.toLowerCase().includes(word) ? 0 : 5), 0);
            questionScore -= Math.min(20, relevanceScore);
            if (relevanceScore > 0) feedback.push("Missing key content");

            questionScore = Math.max(0, questionScore);
            score += questionScore;
            feedbackDetails.push(`Q${currentQuestionIndex + 1} (${questionScore}/100): ${feedback.join(", ") || "Excellent response"}`);
            allTranscripts.push(text.trim());
            addMessage(`Feedback: ${feedback.join(", ") || "Excellent response"}`, "bot");
            
            currentQuestionIndex++;
            setTimeout(askQuestion, 1000);
            updateScore();
        }

        // UI Updates
        function updateProgress() {
            const progress = document.getElementById("progress");
            progress.value = (currentQuestionIndex / interviewQuestions.length) * 100;
        }

        function updateScore() {
            document.getElementById("scoreDisplay").textContent = 
                `Score: ${score}/${interviewQuestions.length * 100}`;
        }

        function endInterview() {
            recognition.stop();
            document.getElementById("chatContainer").style.display = "block";
            addMessage("Interview complete! Here's your full transcript and feedback:", "bot");
            allTranscripts.forEach((text, index) => {
                addMessage(`Q${index + 1}: ${interviewQuestions[index]}`, "bot");
                addMessage(text, "user", true); // Highlight fillers and keywords
            });
            feedbackDetails.forEach(f => addMessage(f, "bot"));
            addMessage(`Final Score: ${score}/${interviewQuestions.length * 100}`, "bot");
            doneButton.disabled = true;
        }

        // Event Listeners
        startButton.addEventListener("click", startInterview);

        doneButton.addEventListener("click", () => {
            const responseTime = Date.now() - responseStartTime;
            evaluateResponse(fullTranscript.trim(), responseTime);
            fullTranscript = "";
            subtitles.style.opacity = 0; // Ensure subtitles fade out
        });

        // Start
        window.onload = () => {
            startButton.disabled = false;
        };
    </script>
</body>
</html>
