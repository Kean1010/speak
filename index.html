<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Interview Bot with Video & Voice</title>
    <style>
        .container {
            width: 800px;
            margin: 20px auto;
            display: flex;
            gap: 20px;
        }
        .chat-container {
            width: 400px;
            border: 1px solid #ccc;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
        }
        .video-container {
            width: 350px;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .bot-message {
            background-color: #f0f0f0;
        }
        .user-message {
            background-color: #e0f0ff;
            margin-left: 20%;
        }
        .input-container {
            width: 400px;
            margin: 10px auto;
            display: flex;
            gap: 10px;
        }
        #progressBar {
            width: 400px;
            height: 20px;
            margin: 10px auto;
        }
        #scoreDisplay {
            width: 400px;
            margin: 10px auto;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-container" id="chatContainer"></div>
        <div class="video-container">
            <video id="video" width="350" height="262" autoplay></video>
            <canvas id="canvas" width="350" height="262" style="display:none"></canvas>
        </div>
    </div>
    <div id="progressBar"><progress id="progress" value="0" max="100"></progress></div>
    <div id="scoreDisplay">Score: 0/100</div>
    <div class="input-container">
        <button id="startInterview">Start Interview</button>
        <button id="doneButton" disabled>Okay, I'm done</button>
    </div>

    <script>
        // Interview setup
        const interviewQuestions = [
            "Tell me about yourself.",
            "What are your strengths?",
            "What are your weaknesses?",
            "Why do you want this job?",
            "Where do you see yourself in 5 years?"
        ];

        let currentQuestionIndex = 0;
        let score = 0;
        let feedbackDetails = [];
        let responseStartTime;
        let fullTranscript = "";
        const maxResponseTime = 60000; // 1 minute

        // Video setup
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");

        // Speech setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;

        // Common filler words
        const fillerWords = ["um", "uh", "like", "you know", "basically", "er", "ah", "so", "well", "actually"];

        // Button references
        const startButton = document.getElementById("startInterview");
        const doneButton = document.getElementById("doneButton");

        // Initialize
        function startInterview() {
            addMessage("Welcome! Please allow camera and microphone access.", "bot");
            setupVideo();
            setupSpeech();
            recognition.start(); // Start microphone once
            updateProgress();
            askQuestion();
            startButton.disabled = true;
            doneButton.disabled = false;
        }

        // Video/Posture/Facial Expression Detection
        async function setupVideo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                analyzeVideo();
            } catch (err) {
                addMessage("Error accessing camera: " + err.message, "bot");
            }
        }

        function analyzeVideo() {
            setInterval(() => {
                ctx.drawImage(video, 0, 0, 350, 262);
                const imageData = ctx.getImageData(0, 0, 350, 262);
                const data = imageData.data;

                // Basic posture check
                const brightness = data.reduce((sum, val) => sum + val) / (350 * 262 * 4);
                if (brightness < 50) {
                    feedbackDetails.push("Posture: Could you sit up straighter?");
                    score -= 2;
                }

                // Simple facial expression detection (mouth curve for smile)
                let smileScore = 0;
                for (let y = 200; y < 250; y += 2) { // Mouth region
                    for (let x = 100; x < 250; x += 2) {
                        const i = (y * 350 + x) * 4;
                        const brightness = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        if (brightness > 150) smileScore++; // Light areas might indicate teeth/smile
                    }
                }
                if (smileScore > 1000) feedbackDetails.push("Expression: Nice smile!");
                else if (smileScore < 500) feedbackDetails.push("Expression: Try smiling more.");

                updateScore();
            }, 5000);
        }

        // Speech Analysis
        function setupSpeech() {
            recognition.onresult = (event) => {
                let interimTranscript = '';
                fullTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        fullTranscript += transcript + " ";
                    } else {
                        interimTranscript += transcript;
                    }
                }

                const displayText = fullTranscript + interimTranscript;
                const container = document.getElementById("chatContainer");
                const existingUserMessage = container.querySelector(".user-message:last-child");
                if (existingUserMessage && !fullTranscript) {
                    existingUserMessage.textContent = displayText;
                } else {
                    addMessage(displayText, "user");
                }
            };

            recognition.onerror = (event) => {
                addMessage("Speech recognition error: " + event.error, "bot");
            };
        }

        function countFillers(text) {
            const words = text.toLowerCase().split(/\s+/).filter(word => word.length > 0);
            const fillerCounts = {};
            fillerWords.forEach(filler => {
                const regex = new RegExp(`\\b${filler}\\b`, "gi");
                const count = (text.match(regex) || []).length;
                if (count > 0) fillerCounts[filler] = count;
            });
            return fillerCounts;
        }

        // Chat functions
        function addMessage(text, type) {
            const container = document.getElementById("chatContainer");
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message", type === "bot" ? "bot-message" : "user-message");
            messageDiv.textContent = text;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function askQuestion() {
            if (currentQuestionIndex < interviewQuestions.length) {
                addMessage(interviewQuestions[currentQuestionIndex], "bot");
                responseStartTime = Date.now();
                updateProgress();
            } else {
                endInterview();
            }
        }

        // Evaluation
        function evaluateResponse(text, responseTime) {
            let questionScore = 100;
            let feedback = [];
            const fillerCounts = countFillers(text);
            const totalFillers = Object.values(fillerCounts).reduce((sum, count) => sum + count, 0);
            const wordCount = text.split(/\s+/).length;
            const uniqueWords = new Set(text.toLowerCase().split(/\s+/)).size;

            if (totalFillers > 1) {
                const fillerPenalty = Math.min(50, (totalFillers - 1) * 10);
                questionScore -= fillerPenalty;
                const fillerDetails = Object.entries(fillerCounts)
                    .map(([word, count]) => `${word} (${count})`)
                    .join(", ");
                feedback.push(`Filler words detected: ${fillerDetails}`);
            }

            const lengthScore = Math.min(20, Math.max(0, (50 - text.length) / 2));
            questionScore -= lengthScore;
            if (lengthScore > 0) feedback.push(`Response too short (${text.length} chars)`);

            const timePenalty = responseTime < 10000 ? 10 * (10 - responseTime / 1000) :
                              responseTime > 45000 ? 10 * (responseTime / 1000 - 45) : 0;
            questionScore -= Math.min(20, timePenalty);
            if (timePenalty > 0) {
                feedback.push(responseTime < 10000 ? "Too rushed" : "Too long");
            }

            const vocabScore = Math.min(20, Math.max(0, (wordCount * 0.5 - uniqueWords) * 2));
            questionScore -= vocabScore;
            if (vocabScore > 0) feedback.push("Limited vocabulary variety");

            const question = interviewQuestions[currentQuestionIndex];
            const keywords = {
                "Tell me about yourself.": ["experience", "background", "skills"],
                "What are your strengths?": ["strong", "good at", "skill"],
                "What are your weaknesses?": ["weak", "improve", "challenge"],
                "Why do you want this job?": ["interested", "role", "company"],
                "Where do you see yourself in 5 years?": ["future", "goal", "plan"]
            }[question] || ["answer", "response"];
            
            const relevanceScore = keywords.reduce((count, word) => 
                count + (text.toLowerCase().includes(word) ? 0 : 5), 0);
            questionScore -= Math.min(20, relevanceScore);
            if (relevanceScore > 0) feedback.push("Missing key content");

            questionScore = Math.max(0, questionScore);
            score += questionScore;
            feedbackDetails.push(`Q${currentQuestionIndex + 1} (${questionScore}/100): ${feedback.join(", ") || "Excellent response"}`);
            addMessage(`Feedback: ${feedback.join(", ") || "Excellent response"}`, "bot");
            
            currentQuestionIndex++;
            setTimeout(askQuestion, 1000);
            updateScore();
        }

        // UI Updates
        function updateProgress() {
            const progress = document.getElementById("progress");
            progress.value = (currentQuestionIndex / interviewQuestions.length) * 100;
        }

        function updateScore() {
            document.getElementById("scoreDisplay").textContent = 
                `Score: ${score}/${interviewQuestions.length * 100}`;
        }

        function endInterview() {
            recognition.stop();
            addMessage("Interview complete! Here's your detailed feedback:", "bot");
            feedbackDetails.forEach(f => addMessage(f, "bot"));
            addMessage(`Final Score: ${score}/${interviewQuestions.length * 100}`, "bot");
            doneButton.disabled = true;
        }

        // Event Listeners
        startButton.addEventListener("click", startInterview);

        doneButton.addEventListener("click", () => {
            const responseTime = Date.now() - responseStartTime;
            evaluateResponse(fullTranscript.trim(), responseTime);
            fullTranscript = "";
        });

        // Start
        window.onload = () => {
            startButton.disabled = false;
        };
    </script>
</body>
</html>
